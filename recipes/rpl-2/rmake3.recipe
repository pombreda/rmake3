#
# Copyright (c) 2010 rPath, Inc.
# This file is distributed under the terms of the MIT License.
# A copy is available at http://www.rpath.com/permanent/mit-license.html
#

class RmakeRecipe(CPackageRecipe):
    name = 'rmake3'
    version = '3.0'

    buildRequires = [
        'chkconfig:runtime',
        'conary:python',
        'conary-repository:python',
        'desktop-file-utils:runtime',
        'info-rmake-chroot:user',
        'info-rmake:user',
        'libcap:devel',
        'm2crypto:python',
        'psycopg2:python',
        'python:devel',
        'python-setuptools:python',
        'python-twisted:python',
        'python-txpostgres:python',
        'python-wokkel:python',
    ]

    def setup(r):
        r.addMercurialSnapshot('/home/gxti/code/products/rmake/trunk/rmake')
        #http://hg.rpath.com/rmake')
        r.Make()
        r.MakeInstall('PKGNAME=%(name)s NO_COMPILE=1')
        r.CompilePython()

        r.MakeDirs('/var/{lib,log}/%(name)s')
        r.MakeDirs('/srv/%(name)s', mode=0700)
        r.MakeDirs('/etc/%(name)s/{server,client}.d')
        r.Ownership('rmake', 'rmake',
                '/srv/%(name)s',
                '/var/%(name)s',
                '/var/lib/%(name)s',
                '/var/log/%(name)s',
                '/var/run/%(name)s',
                )
        r.ExcludeDirectories(exceptions='/var/(lib|log)/%(name)s')
        r.ExcludeDirectories(exceptions='/srv/%(name)s')
        r.ExcludeDirectories(exceptions='/etc/%(name)s/client.d')
        r.ExcludeDirectories(exceptions='/etc/%(name)s/server.d')

        r.Doc('CPL')

        # library
        r.Requires('iproute:runtime', 'procutil.py')
        r.Requires(exceptDeps='python: (epdb|%(name)s.cmdline.password)')
        r.ComponentProvides('%(version)s')

        # chroothelper
        chpath = '/usr/libexec/%(name)s/chroothelper'
        r.SetModes(chpath, 04755)
        r.Provides('file', chpath)
        r.Requires(chpath, 'rootfactory.py')
        r.Requires('busybox:runtime', chpath)
        r.UtilizeUser('rmake-chroot', chpath)
        r.UtilizeGroup('rmake-chroot', chpath)

        ## package rmake-node
        # This package has files required on individual build nodes
        # controlled by a head node
        r.PackageSpec('rmake-node',
                '%(initdir)s/%(name)s-node',
                '%(sbindir)s/%(name)s-node',
                '%(mandir)s/.*%(name)s-node.*',
                )
        r.Requires('%(name)s:python(%(version)s)', '%(sbindir)s/%(name)s-node')


        ## package rmake-multinode-server
        # This package has files required on the head node that controls
        # all the individual build nodes that are connected to it
        r.PackageSpec('rmake-multinode-server',
                '%(initdir)s/rmake-dispatcher',
                '%(sbindir)s/rmake-dispatcher',
                )
